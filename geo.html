<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Captura de geolocalización</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial;margin:24px}
    code{background:#f4f4f4;padding:2px 4px}
  </style>
</head>
<body>
  <h3>Prueba de geolocalización</h3>
  <div id="log">Cargando...</div>

  <script>
  const log = (t)=>document.getElementById('log').innerHTML = t;

  (async () => {
    try {
      log('Pidiendo permiso de ubicación…');

      async function getGeo() {
        if (!navigator.geolocation) return { lat:null, lon:null, err:'no-geolocation' };
        return await new Promise((resolve) => {
          navigator.geolocation.getCurrentPosition(
            p => resolve({ lat:p.coords.latitude, lon:p.coords.longitude }),
            e => resolve({ lat:null, lon:null, err:e.message }),
            { enableHighAccuracy:true, timeout:15000 }
          );
        });
      }

      const g = await getGeo();
      console.log('Geo:', g);
      log('Ubicación: <code>'+JSON.stringify(g)+'</code>');

      const ts = new Date().toISOString();
      log('Ubicación: <code>'+JSON.stringify(g)+'</code><br>Enviando a backend…');

      // MISMO ORIGEN → funciona local y en Render
      const url = `${window.location.origin}/geo-capture`;

      const resp = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ lat: g.lat, lon: g.lon, ts })
      });

      const j = await resp.json();
      console.log('Respuesta backend:', j);
      log('OK, guardado: <code>'+JSON.stringify(j)+'</code>');
    } catch (e) {
      console.error(e);
      log('Error en página: <code>'+e+'</code>');
    }
  })();
  </script>
</body>
</html>
